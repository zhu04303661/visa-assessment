# 开发环境Dockerfile
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 安装Python和系统依赖
RUN apk add --no-cache \
    python3 \
    py3-pip \
    gcc \
    g++ \
    python3-dev \
    curl

# 安装pnpm
RUN npm install -g pnpm

# 复制package.json、pnpm-lock.yaml和.npmrc
COPY package.json pnpm-lock.yaml .npmrc ./

# 安装前端依赖（使用.npmrc配置解决React 19兼容性问题）
RUN pnpm install

# 复制Python依赖文件
COPY ace_gtv/requirements.txt ./

# 创建Python虚拟环境并安装依赖
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
RUN pip install --no-cache-dir -r requirements.txt

# 复制所有源代码（包括.env.local）
COPY . .

# 创建必要的目录
RUN mkdir -p ace_gtv/data ace_gtv/personal_kb ace_gtv/resumes

# 创建开发环境启动脚本
RUN echo '#!/bin/sh\n\
# 激活Python虚拟环境\n\
source /opt/venv/bin/activate\n\
\n\
# 启动后端服务\n\
cd /app/ace_gtv\n\
python resume_processor.py &\n\
python api_server.py &\n\
\n\
# 等待后端服务启动\n\
sleep 5\n\
\n\
# 启动前端开发服务器\n\
cd /app\n\
pnpm dev\n\
' > /app/start_dev.sh && chmod +x /app/start_dev.sh

# 暴露端口
EXPOSE 3000 5001 5002

# 设置环境变量
ENV NODE_ENV=development
ENV PYTHONUNBUFFERED=1

# 启动开发服务
CMD ["/app/start_dev.sh"]
